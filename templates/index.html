<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—º Ä°zmit Rota PlanlayÄ±cÄ±</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .payment-method {
            display: none;
            margin-top: 10px;
        }

        .payment-method.active {
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            margin-left: 5px;
        }

        .badge-student {
            background-color: #4caf50;
        }

        .badge-teacher {
            background-color: #2196f3;
        }

        .badge-senior {
            background-color: #9c27b0;
        }
    </style>
</head>
<body>

    <h1>ğŸ—º Ä°zmit Rota PlanlayÄ±cÄ±</h1>

    <form id="routeForm">
        <div class="form-section">
            <h3>ğŸ“ Rota Bilgileri</h3>
            <label>BaÅŸlangÄ±Ã§ DuraÄŸÄ±:</label>
            <select id="start" required>
                <option value="">Haritadan SeÃ§</option>
            </select>

            <label>Hedef DuraÄŸÄ±:</label>
            <select id="end" required>
                <option value="">Durak SeÃ§</option>
            </select>

            <p>ğŸ“Œ <strong>Haritaya tÄ±klayarak en yakÄ±n duraÄŸÄ± otomatik seÃ§ebilirsiniz!</strong></p>
        </div>

        <div class="form-section">
            <h3>ğŸ‘¤ Yolcu Bilgileri</h3>
            <label>Yolcu Tipi:</label>
            <select id="passenger-type">
                <option value="general">Genel Yolcu</option>
                <option value="student">Ã–ÄŸrenci</option>
                <option value="teacher">Ã–ÄŸretmen</option>
                <option value="senior">65+ YaÅŸ</option>
            </select>

            <div id="passenger-info">
                <label>Ä°sim:</label>
                <input type="text" id="passenger-name" placeholder="Ä°sim (Ä°steÄŸe baÄŸlÄ±)">

                <label>YaÅŸ:</label>
                <input type="number" id="passenger-age" min="1" max="120" value="30">
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ’° Ã–deme Bilgileri</h3>
            <div class="payment-methods">
                <div>
                    <input type="checkbox" id="payment-cash" name="payment-methods" value="cash">
                    <label for="payment-cash">Nakit</label>
                    <div class="payment-method" id="cash-details">
                        <label>Nakit MiktarÄ± (TL):</label>
                        <input type="number" id="cash-amount" min="0" step="0.01" value="100">
                    </div>
                </div>

                <div>
                    <input type="checkbox" id="payment-credit" name="payment-methods" value="credit_card">
                    <label for="payment-credit">Kredi KartÄ±</label>
                    <div class="payment-method" id="credit-details">
                        <label>Limit (TL):</label>
                        <input type="number" id="credit-limit" min="0" step="0.01" value="1000">
                    </div>
                </div>

                <div>
                    <input type="checkbox" id="payment-kentcard" name="payment-methods" value="kent_card">
                    <label for="payment-kentcard">KentKart</label>
                    <div class="payment-method" id="kentcard-details">
                        <label>KentKart Bakiyesi (TL):</label>
                        <input type="number" id="kentcard-balance" min="0" step="0.01" value="50">
                    </div>
                </div>
            </div>
        </div>

        <button type="submit">Rota Bul</button>
        <button id="resetSelection" type="button">BaÅŸlangÄ±Ã§ ve VarÄ±ÅŸ NoktasÄ±nÄ± SÄ±fÄ±rla</button>
    </form>

    <div id="map"></div>

    <div id="routes-container">
        <div id="nearest-stop-info" class="route-panel"></div>
        <div id="selected-route-details" class="route-panel"></div>
        <div id="alternative-routes" class="route-panel">
            <h3>ğŸ›¤ Alternatif Rotalar</h3>
            <div id="alt-routes-list"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.querySelectorAll('input[name="payment-methods"]').forEach(input => {
            input.addEventListener('change', function() {
                const detailsId = this.value === 'cash' ? 'cash-details' :
                                 this.value === 'credit_card' ? 'credit-details' : 'kentcard-details';
                document.getElementById(detailsId).classList.toggle('active', this.checked);
            });
        });

        // Update the route form submit handler to include passenger and payment data
        document.getElementById("routeForm").addEventListener("submit", function(event) {
            event.preventDefault();

            let startSelect = document.getElementById("start");
            let endSelect = document.getElementById("end");

            let startId = startSelect.value;
            let endId = endSelect.value;

            if (!startId || !endId) {
                alert("LÃ¼tfen baÅŸlangÄ±Ã§ ve hedef duraÄŸÄ±nÄ± seÃ§in.");
                return;
            }

            const passengerType = document.getElementById("passenger-type").value;
            const passengerName = document.getElementById("passenger-name").value || "Anonim";
            const passengerAge = parseInt(document.getElementById("passenger-age").value) || 30;

            const paymentMethods = [];
            const paymentInputs = document.querySelectorAll('input[name="payment-methods"]:checked');
            paymentInputs.forEach(input => {
                paymentMethods.push(input.value);
            });

            const cashAmount = parseFloat(document.getElementById("cash-amount").value) || 0;
            const creditLimit = parseFloat(document.getElementById("credit-limit").value) || 0;
            const kentCardBalance = parseFloat(document.getElementById("kentcard-balance").value) || 0;

            document.getElementById("selected-route-details").innerHTML = '<h3>â³ Rota hesaplanÄ±yor...</h3>';
            document.getElementById("alt-routes-list").innerHTML = '';

            const requestBody = {
                start: startId,
                end: endId,
                passenger_type: passengerType,
                passenger_name: passengerName,
                passenger_age: passengerAge,
                payment_methods: paymentMethods,
                cash_amount: cashAmount,
                credit_limit: creditLimit,
                kent_card_balance: kentCardBalance
            };

            console.log("ğŸ“ Rota isteÄŸi:", requestBody);

            fetch("/get_routes", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸš€ API YanÄ±tÄ±:", data);

                if (!data.route) {
                    console.error("ğŸš¨ API'den geÃ§erli rota verisi gelmedi!", data);
                    document.getElementById("selected-route-details").innerHTML = `
                        <div class="info-block" style="background-color: #ffe5e5; border-left: 4px solid #ff3b30;">
                            âš ï¸ Rota bulunamadÄ±! LÃ¼tfen farklÄ± duraklar seÃ§in.
                        </div>`;
                    return;
                }

                currentRouteDetails = data;
                updateMap(data);
                displayRouteDetails(data);

                fetch("/get_alternative_routes", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                })
                .then(res => res.json())
                .then(alternatives => {
                    console.log("ğŸ” Alternatif Rotalar:", alternatives);
                    displayAlternativeRoutes(alternatives);
                })
                .catch(error => {
                    console.error("âš ï¸ Alternatif rotalar alÄ±nÄ±rken hata:", error);
                    document.getElementById("alt-routes-list").innerHTML = `
                        <div class="info-block" style="background-color: #fff3cd; border-left: 4px solid #ffcc00;">
                            âš ï¸ Alternatif rotalar alÄ±namadÄ±.
                        </div>`;
                });
            })
            .catch(error => {
                console.error("ğŸš¨ Rota verisi alÄ±nÄ±rken hata oluÅŸtu:", error);
                document.getElementById("selected-route-details").innerHTML = `
                    <div class="info-block" style="background-color: #ffe5e5; border-left: 4px solid #ff3b30;">
                        âš ï¸ Rota hesaplanÄ±rken bir hata oluÅŸtu!
                    </div>`;
            });
        });

        function displayRouteDetailsFromData(details, container) {
            const passengerType = document.getElementById("passenger-type").value;
            let discountBadge = '';

            if (passengerType === 'student') {
                discountBadge = '<span class="badge badge-student">%50 Ä°ndirimli</span>';
            } else if (passengerType === 'teacher') {
                discountBadge = '<span class="badge badge-teacher">%25 Ä°ndirimli</span>';
            } else if (passengerType === 'senior') {
                discountBadge = '<span class="badge badge-senior">%100 Ä°ndirimli (20 biniÅŸ limiti)</span>';
            }

            let html = `
                <h3>ğŸš Rota DetaylarÄ± ${discountBadge}</h3>
                <div class="route-steps">
            `;

            if (walkingToStart) {
                const icon = walkingToStart.taxi_required ? 'ğŸš–' : 'ğŸš¶';
                const method = walkingToStart.taxi_required ? 'Taksi' : 'YÃ¼rÃ¼yerek';
                const costText = walkingToStart.taxi_required ? ` | ğŸ’° Ãœcret: ${walkingToStart.cost.toFixed(2)} TL` : '';
                const timeText = walkingToStart.taxi_required ? ` | â³ SÃ¼re: ${walkingToStart.time.toFixed(2)} dk` : '';
                html += `
                    <div class="route-stop ${walkingToStart.taxi_required ? 'route-type-taxi' : 'route-type-walk'}">
                        <div class="transport-icon">${icon}</div>
                        <div>
                            <strong>ğŸ  BaÅŸlangÄ±Ã§ Konumu â†’ ${walkingToStart.name}</strong>
                            <div class="route-step-details">
                                ğŸ“ Mesafe: ${(walkingToStart.distance / 1000).toFixed(2)} km (${method})${costText}${timeText}
                            </div>
                        </div>
                    </div>
                `;
            }

            details.steps.forEach((step, index) => {
                const icon = getTransportIcon(step.transportType);
                const badge = getTransportBadge(step.transportType);

                html += `
                    <div class="route-stop ${getRouteTypeClass(step.transportType)}">
                        <div class="transport-icon">${icon}</div>
                        <div>
                            <strong>${index + 1}. ${step.fromName} â†’ ${step.toName}</strong> ${badge}
                            <div class="route-step-details">
                                â³ SÃ¼re: ${step.time} dk | ğŸ’° Ãœcret: ${step.cost.toFixed(2)} TL | ğŸ“ Mesafe: ${step.distance.toFixed(1)} km
                            </div>
                        </div>
                    </div>
                `;

                if (index < details.steps.length - 1 && details.steps[index + 1].transportType === "transfer") {
                    html += `<div class="transfer-line">Aktarma NoktasÄ±</div>`;
                }
            });

            if (walkingToEnd) {
                const icon = walkingToEnd.taxi_required ? 'ğŸš–' : 'ğŸš¶';
                const method = walkingToEnd.taxi_required ? 'Taksi' : 'YÃ¼rÃ¼yerek';
                const costText = walkingToEnd.taxi_required ? ` | ğŸ’° Ãœcret: ${walkingToEnd.cost.toFixed(2)} TL` : '';
                const timeText = walkingToEnd.taxi_required ? ` | â³ SÃ¼re: ${walkingToEnd.time.toFixed(2)} dk` : '';
                html += `
                    <div class="route-stop ${walkingToEnd.taxi_required ? 'route-type-taxi' : 'route-type-walk'}">
                        <div class="transport-icon">${icon}</div>
                        <div>
                            <strong>${walkingToEnd.name} â†’ ğŸ VarÄ±ÅŸ Konumu</strong>
                            <div class="route-step-details">
                                ğŸ“ Mesafe: ${(walkingToEnd.distance / 1000).toFixed(2)} km (${method})${costText}${timeText}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;

            // Add payment method information
            const selectedPayments = Array.from(document.querySelectorAll('input[name="payment-methods"]:checked'))
                .map(input => input.value === 'cash' ? 'Nakit' : input.value === 'credit_card' ? 'Kredi KartÄ±' : 'KentKart')
                .join(', ');

            html += `
                <div class="route-summary">
                    <div>
                        <strong>ğŸ’° Toplam Ãœcret</strong>
                        <div>${details.totalCost.toFixed(2)} TL</div>
                    </div>
                    <div>
                        <strong>â³ Toplam SÃ¼re</strong>
                        <div>${details.totalTime} dk</div>
                    </div>
                    <div>
                        <strong>ğŸ“ Toplam Mesafe</strong>
                        <div>${details.totalDistance.toFixed(1)} km</div>
                    </div>
                    <div>
                        <strong>ğŸ”„ Aktarma SayÄ±sÄ±</strong>
                        <div>${details.totalTransfers}</div>
                    </div>
                </div>
                <div class="payment-info">
                    <strong>ğŸ’³ Ã–deme YÃ¶ntemi:</strong> ${selectedPayments || 'Belirtilmedi'}
                </div>
            `;

            container.innerHTML = html;
        }
    </script>
</body>
</html>